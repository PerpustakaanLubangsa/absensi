<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Absensi Pustakawan | Terminal Absen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#0e7490', // Cyan-700
                        'secondary': '#16a34a', // Green-600
                        'dark-bg': '#1f2937', // Gray-800
                        'light-bg': '#f3f4f6', // Gray-100
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* Card utama untuk kesan modern */
        .card {
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.04), 
                        0 3px 6px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.08), 
                        0 5px 10px rgba(0, 0, 0, 0.08);
        }

        /* Clock Style yang lebih menonjol */
        #real-time-clock {
            text-shadow: 3px 3px 6px rgba(14, 116, 144, 0.2);
            letter-spacing: -2px;
        }

        /* Status Button Styles */
        .status-button {
            font-weight: 600;
            transition: all 0.2s ease;
            border-bottom-width: 4px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            min-width: 60px; /* Tambahkan min-width agar tombol tidak terlalu kecil */
        }

        /* ACTIVE STATE - Warna lebih solid & shadow */
        .status-hadir-active { background-color: #10b981; border-color: #059669; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.4); }
        .status-izin-active { background-color: #f59e0b; border-color: #d97706; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.4); }
        .status-alpha-active { background-color: #ef4444; border-color: #dc2626; box-shadow: 0 2px 4px rgba(239, 68, 68, 0.4); }
        .status-belumabsen-active { background-color: #9ca3af; border-color: #6b7280; box-shadow: 0 2px 4px rgba(156, 163, 175, 0.4); }

        /* INACTIVE STATE - Lebih smooth */
        .status-inactive {
            background-color: #e5e7eb;
            color: #4b5563;
            opacity: 0.9;
            border-color: #d1d5db;
        }
        .status-inactive:hover {
            opacity: 1;
            background-color: #d1d5db;
            transform: translateY(-1px);
        }

        /* Floating Button */
        #floating-buttons-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            z-index: 100;
        }
        .floating-button {
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .floating-button svg {
            width: 32px;
            height: 32px;
        }
        .admin-button {
            background-color: #0e7490;
            color: white;
            box-shadow: 0 6px 15px rgba(14, 116, 144, 0.5);
        }
        .admin-button:hover {
            background-color: #0f766e;
            transform: scale(1.1);
        }
        .pinjam-button {
            background-color: #facc15;
            color: #3f3f46;
            box-shadow: 0 6px 15px rgba(250, 204, 21, 0.5);
        }
        .pinjam-button:hover {
            background-color: #eab308;
            transform: scale(1.1);
        }

        /* Grid - PERBAIKAN UTAMA DI SINI */
        .librarian-grid {
            /* Menggunakan repeat(auto-fill, minmax) agar kolom terisi penuh */
            /* Jika lebar minimum 300px tidak terpenuhi, kartu akan turun ke baris baru */
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)) !important; 
            gap: 32px;
        }
        
        /* Shift Accent */
        .pagi-accent-border { border-color: #0e7490; }
        .text-pagi-accent { color: #0e7490; }
        .malam-accent-border { border-color: #3b82f6; }
        .text-malam-accent { color: #1e40af; }

    </style>
</head>

<body>
    <div id="app-container" class="min-h-screen flex flex-col items-center justify-center p-6 relative">

        <header class="w-full max-w-6xl mb-10 text-center">
            <h1 id="real-time-clock" class="text-7xl md:text-8xl font-extrabold text-primary mb-0 animate-pulse">00:00:00</h1>
            <p id="today-display" class="text-xl font-semibold text-gray-500 mt-2">Loading...</p>
        </header>

        <main class="w-full max-w-6xl">
            <div id="attendance-display" class="space-y-12"></div>
        </main>

        <div id="floating-buttons-container">
            <button id="openPinjamGandaBtn" class="floating-button pinjam-button" title="Buka Sistem Peminjaman Ganda">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h12.38a2 2 0 0 1 1.62.78l3 3.32a2 2 0 0 1 .44 1.34v10.86z" />
                    <line x1="16" y1="21" x2="16" y2="3" />
                    <path d="M12 17h8" />
                    <path d="M12 13h4" />
                    <path d="M12 9h2" />
                </svg>
            </button>
            
            <a href="admin.html" class="floating-button admin-button" title="Pergi ke Halaman Admin">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
            </a>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // === FIREBASE CONFIG ===
        const app = initializeApp({
            apiKey: "AIzaSyBb-hbcc_ZE2hH6dlc81HbIGMQi96y4qYI",
            authDomain: "absensi-7ef83.firebaseapp.com",
            databaseURL: "https://absensi-7ef83-default-rtdb.firebaseio.com",
            projectId: "absensi-7ef83",
            storageBucket: "absensi-7ef83.firebasestorage.app",
            messagingSenderId: "661765044421",
            appId: "1:661765044421:web:b8578a195a6d208dc4d8ac"
        });
        const db = getDatabase(app);

        // === KONSTANTA ===
        const DAYS = ['Ahad', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        const SHIFT = {
            pagi: { name: 'Pagi', range: '08:00 - 11:00', start: 480, end: 660 },
            malam: { name: 'Malam', range: '21:00 - 22:30', start: 1260, end: 1350 }
        };

        const todayDisplay = document.getElementById('today-display');
        const attendanceDisplay = document.getElementById('attendance-display');
        const realTimeClock = document.getElementById('real-time-clock');
        const openPinjamGandaBtn = document.getElementById('openPinjamGandaBtn');

        const getTodayInfo = () => {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            return {
                key: `${y}-${m}-${d}`,
                name: DAYS[now.getDay()],
                formatted: now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })
            };
        };

        const updateClock = () => {
            const now = new Date();
            realTimeClock.textContent = now.toLocaleTimeString('id-ID', { hour12: false });
            realTimeClock.classList.remove('animate-pulse');
            void realTimeClock.offsetWidth; 
            if (now.getSeconds() % 10 === 0) {
                 realTimeClock.classList.add('animate-pulse');
            }

            if (now.getSeconds() === 0 || todayDisplay.textContent === 'Loading...')
                todayDisplay.textContent = getTodayInfo().formatted;
        };

        const getActiveShift = () => {
            const now = new Date();
            const totalMin = now.getHours() * 60 + now.getMinutes();
            return Object.entries(SHIFT)
                .filter(([_, s]) => totalMin >= s.start && totalMin < s.end)
                .map(([k, s]) => ({ key: k, ...s }));
        };

        const btnClass = (status, cur) => {
            // Ubah 'rounded-xl' menjadi 'rounded-lg' di base class untuk proporsi yang lebih baik
            const base = "status-button px-4 py-3 text-white rounded-lg text-sm flex-1 mx-1 border-b-4";
            const map = {
                'Hadir': 'status-hadir-active',
                'Izin': 'status-izin-active',
                'Alpha': 'status-alpha-active',
                'Belum Absen': 'status-belumabsen-active'
            };
            const currentStatusKey = ['Hadir', 'Izin', 'Alpha'].includes(cur) ? cur : 'Belum Absen';

            return status === currentStatusKey ? `${base} ${map[currentStatusKey]}` : `${base} status-inactive`;
        };

        const renderCard = (lib, shiftKey) => {
            const time = lib.checkIn ? new Date(lib.checkIn).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '---';
            const status = ['Hadir', 'Izin', 'Alpha'].includes(lib.status) ? lib.status : 'Belum Absen';
            const id = `card-${shiftKey}-${lib.index}`;
            return `
            <div id="${id}" data-shift="${shiftKey}" data-index="${lib.index}" class="card p-6 flex flex-col items-center text-center shadow-lg hover:shadow-xl">
                <div class="w-24 h-24 bg-light-bg rounded-full flex items-center justify-center mb-4 shadow-inner border-4 border-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#0e7490" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <h4 class="text-xl font-extrabold text-gray-800 mb-1">${lib.name}</h4>
                <p class="text-sm text-gray-500 mb-5">Check-in: <span class="font-bold text-gray-700" id="checkin-${shiftKey}-${lib.index}">${time}</span></p>
                <div class="w-full flex justify-between space-x-2 border-t pt-4 border-gray-100">
                    ${['Hadir','Izin','Alpha'].map(s=>`<button data-status="${s}" class="${btnClass(s,status)}">${s}</button>`).join('')}
                </div>
            </div>`;
        };

        const renderAttendance = (schedule) => {
            attendanceDisplay.innerHTML = '';
            const shifts = getActiveShift();
            if (!shifts.length) {
                attendanceDisplay.innerHTML = `
                <div class="text-center py-16 card bg-white border-t-8 border-gray-400">
                    <h3 class="text-3xl font-bold text-gray-700 mb-2">üò¥ Pintu Absensi Sedang Tertutup</h3>
                    <p class="text-gray-500 mt-4">Jam Piket Aktif: Pagi ${SHIFT.pagi.range}, Malam ${SHIFT.malam.range}</p>
                </div>`;
                return;
            }
            const frag = document.createDocumentFragment();
            shifts.forEach(s => {
                const list = schedule?.[s.key] || [];
                if (!list.length) return;
                const div = document.createElement('div');
                div.className = `p-10 card border-t-8 ${s.key === 'pagi' ? 'pagi-accent-border' : 'malam-accent-border'}`;
                div.innerHTML = `
                <div class="shift-header mb-8">
                    <h3 class="text-3xl font-extrabold ${s.key === 'pagi' ? 'text-pagi-accent' : 'text-malam-accent'} mb-2">Shift ${s.name}</h3>
                    <p class="text-lg text-gray-600">Jadwal: ${s.range}</p>
                </div>
                <div class="librarian-grid grid gap-8">${list.map((lib,i)=>renderCard({...lib,index:i},s.key)).join('')}</div>`;
                frag.appendChild(div);
            });
            attendanceDisplay.appendChild(frag);
        };

        const startListener = async () => {
            const today = getTodayInfo();
            const dailyRef = ref(db, `librarian_schedules/${today.key}`);
            try {
                let schedule = (await get(dailyRef)).val();
                if (!schedule) {
                    const template = (await get(ref(db, `recurring_templates/${today.name}`))).val();
                    if (template) {
                        schedule = { pagi: template.pagi || [], malam: template.malam || [] };
                        await set(dailyRef, schedule);
                    }
                }
                onValue(dailyRef, snap => renderAttendance(snap.val()));
            } catch (e) {
                console.error(e);
                attendanceDisplay.innerHTML = `<div class="text-center py-16 card bg-red-50 border-t-8 border-red-500 text-red-700">
                    <h3 class="text-2xl font-bold mb-2">‚ùå Gagal Memuat Data</h3>
                    <p>Silakan periksa koneksi internet Anda.</p></div>`;
            }
        };

        // === HANDLER BUTTON (Delegasi Event) ===
        attendanceDisplay.addEventListener('click', async (e) => {
            const btn = e.target.closest('button[data-status]');
            if (!btn) return;

            const card = btn.closest('[data-shift]');
            const shift = card.dataset.shift;
            const index = card.dataset.index;
            const status = btn.dataset.status;
            const todayKey = getTodayInfo().key;
            const path = `librarian_schedules/${todayKey}/${shift}/${index}`;

            const currentActiveButton = card.querySelector('.status-hadir-active, .status-izin-active, .status-alpha-active, .status-belumabsen-active');
            const currentActiveStatus = currentActiveButton ? currentActiveButton.textContent.trim() : 'Belum Absen';

            let finalStatus;
            
            if (status === 'Hadir' && currentActiveStatus === 'Hadir') {
                finalStatus = 'Belum Absen';
            } else if (status !== 'Hadir' && currentActiveStatus === status) {
                return; 
            } else {
                finalStatus = status; 
            }

            const now = new Date();
            const updateData = {
                status: finalStatus,
                checkIn: finalStatus === 'Hadir' ? now.toISOString() : null,
                absentBy: finalStatus !== 'Belum Absen' && finalStatus !== 'Hadir' ? 'SharedTerminal' : null
            };

            card.querySelectorAll('button').forEach(b => {
                const btnStatus = b.textContent.trim();
                b.className = btnClass(btnStatus, finalStatus); 
            });

            const timeEl = card.querySelector(`#checkin-${shift}-${index}`);
            if (timeEl) timeEl.textContent = finalStatus === 'Hadir' ? now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '---';

            try { await update(ref(db, path), updateData); }
            catch (err) { console.error(err); alert('Gagal menyimpan status'); }
        });

        // ------------------------------------------------------------------
        // Logika Komunikasi dengan Halaman Induk (postMessage)
        // ------------------------------------------------------------------
        if (openPinjamGandaBtn) {
            openPinjamGandaBtn.addEventListener('click', function() {
                if (window.parent !== window) {
                    window.parent.postMessage({
                        action: 'openPinjamGanda'
                    }, '*');
                }
            });
        }
        // ------------------------------------------------------------------


        // === INISIALISASI ===
        window.onload = () => {
            updateClock();
            setInterval(updateClock, 1000);
            startListener();
        };
    </script>
</body>
</html>
