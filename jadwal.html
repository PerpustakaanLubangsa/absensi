<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Piket Pustakawan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mengimpor Font Inter untuk tampilan modern */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Pengaturan Body dan Layout Utama */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: auto; 
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f7f9fb; /* Latar belakang abu-abu sangat lembut */
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            padding: 3rem 0; 
        }
        
        /* Style untuk container utama (Kartu Sudut Lembut & Bayangan Halus) */
        .container-card {
            background-color: white;
            border-radius: 5px; /* Lebih lembut */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02); /* Bayangan lebih ringan */
            max-width: 95%; 
            width: 1400px; /* Diperluas sedikit */
            margin: 0 auto;
            overflow: hidden; 
            border: 1px solid #e2e8f0; 
        }
        
        /* Table Styles - Fokus pada kebersihan */
        th, td {
            padding: 14px 16px; /* Padding lebih lebar untuk kesan modern */
            text-align: left;
            border-right: 1px solid #f1f5f9; 
            border-bottom: 1px solid #f1f5f9; 
            overflow: hidden;
            vertical-align: middle; /* Tengah vertikal */
            transition: background-color 0.2s;
            white-space: nowrap; /* Menjaga sel hari tetap dalam satu baris */
        }

        /* Hover pada sel hari */
        td:not(:first-child):hover {
            background-color: #f8fafc; 
        }

        /* Kolom untuk Shift/Waktu */
        th:first-child, td:first-child {
            width: 15%; 
            font-weight: 600;
            background-color: #f8fafc; 
            border-right: 2px solid #e2e8f0; 
            position: sticky; /* Sticky untuk kolom pertama */
            left: 0;
            z-index: 20; 
            white-space: normal; /* Biarkan shift/waktu membungkus */
        }
        
        /* Style untuk Header Kolom (Hari) */
        th {
            background-color: #ecfeff; /* Cyan-50 */
            color: #0e7490; /* Cyan-700 */
            font-weight: 700;
            border-top: 3px solid #06b6d4; /* Aksen garis lebih tipis */
            position: sticky; 
            top: 0;
            z-index: 30; /* Lebih tinggi dari kolom pertama */
            text-align: center !important; /* Hari di tengah */
        }
        
        /* Menghilangkan border pada kolom dan baris terakhir */
        th:last-child, td:last-child {
            border-right: none;
        }
        tr:last-child td {
            border-bottom: none;
        }

        /* NEW DIVIDER STYLES (Dipertahankan, sedikit lebih lembut) */
        .divider-row td {
            height: 30px;
            font-weight: 600;
            text-transform: uppercase;
            color: white;
            text-align: center !important;
            font-size: 0.85rem;
            padding: 6px;
            border-right: none;
            border-bottom: none;
            cursor: default;
        }
        .divider-harian td {
            background-color: #06b6d4; /* Cyan-500 */
            color: #fff;
        }
        .divider-pembina td {
            background-color: #0e7490; /* Cyan-700 */
            color: #fff;
        }
        /* END NEW DIVIDER STYLES */
        
        /* Shift Badges */
        .shift-badge-pagi {
            background-color: #e0f7f2; /* Hijau Mint-Cyan Soft */
            color: #0e9076; /* Hijau Tua/Teal */
        }
        .shift-badge-malam {
            background-color: #ecf0ff; /* Biru Indigo Soft */
            color: #4338ca; /* Indigo Tua */
        }
        .shift-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px; /* Lebih kecil */
            font-size: 0.75rem; /* Lebih kecil */
            font-weight: 700;
            margin-bottom: 2px;
            letter-spacing: 0.05em;
        }
        
        /* Style untuk daftar pustakawan */
        .librarian-text {
             font-size: 0.9rem; 
             line-height: 1.4;
             color: #1f2937; /* Gray-900 */
             white-space: normal; /* Biarkan konten cell membungkus */
        }
        /* Mengubah warna teks cell kosong */
        .empty-cell {
            color: #cbd5e1; /* Slate-300 - Sangat lembut */
            font-style: italic;
            font-size: 0.85rem;
        }
        
        /* Judul Kartu - Header */
        .card-header {
            padding: 24px 24px;
            border-bottom: 1px solid #e2e8f0;
            background-color: white; 
            display: flex;
            justify-content: space-between; 
            align-items: center;
        }
        
        /* Logo Styling */
        .logo {
            height: 48px; 
            width: auto;
        }

        /* Header Title Styling */
        .header-title-group h1 {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 800;
            color: #1f2937;
        }
        .header-title-group {
            text-align: right; 
        }

        /* Table Wrapper */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
        }
        
        /* ======================================= */
        /* MEDIA PRINT STYLES (Print-Friendly) */
        /* ======================================= */
        @media print {
            body { background-color: white !important; padding: 0 !important; font-size: 9pt; }
            .container-card { width: 100% !important; max-width: none !important; box-shadow: none !important; border: none !important; }
            .table-wrapper { overflow-x: visible !important; }
            
            /* Warna latar belakang dan teks untuk cetak */
            .card-header, th, .divider-row td, .shift-badge {
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;
            }
            .card-header, th:first-child, td:first-child { 
                background-color: #f3f4f6 !important; /* Abu-abu ringan */
            }
            th {
                background-color: #e5e7eb !important; 
                color: #1f2937 !important;
                border-top: 2px solid #06b6d4 !important; 
            }
            
            /* Divider */
            .divider-row td {
                color: white !important;
                background-color: #4b5563 !important; /* Abu-abu tua */
            }

            /* Badge */
            .shift-badge {
                border: 1px solid #94a3b8 !important;
                background-color: white !important;
                color: #1f2937 !important;
            }
            
            /* General Table Styles */
            th, td {
                border-color: #d1d5db !important;
                padding: 8px 10px !important; 
            }
            
        }
    </style>
</head>
<body>

    <div class="container-card">
        <div class="card-header">
             <img src="logo.png" alt="Logo Organisasi" class="logo">
             
             <div class="header-title-group">
                 <h1 class="font-extrabold">Jadwal Piket Pustakawan Mingguan</h1>
                 </div>
        </div>
        <div id="schedule-table-container" class="table-wrapper">
            <div id="loading-indicator" class="text-center py-20 text-gray-500 text-xl font-medium">Memuat Jadwal...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // =================================================================
        // KONFIGURASI FIREBASE (HARUS SAMA DENGAN FILE LAIN)
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBb-hbcc_ZE2hH6dlc81HbIGMQi96y4qYI",
            authDomain: "absensi-7ef83.firebaseapp.com",
            databaseURL: "https://absensi-7ef83-default-rtdb.firebaseio.com",
            projectId: "absensi-7ef83",
            storageBucket: "absensi-7ef83.firebasestorage.app",
            messagingSenderId: "661765044421",
            appId: "1:661765044421:web:b8578a195a6d208dc4d8ac"
        };
        // =================================================================

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Hari diurutkan dari Senin hingga Ahad untuk kolom horizontal
        const ALL_DAYS_OF_WEEK = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Ahad'];
        
        // Semua shift yang relevan
        const ALL_SHIFTS = [
            { key: 'pagi', name: 'Pagi', time: '08:00 - 11:00', badgeClass: 'shift-badge-pagi' },
            { key: 'malam', name: 'Malam', time: '21:00 - 22:30', badgeClass: 'shift-badge-malam' }
        ];

        /**
         * Mengambil data jadwal mingguan dan merendernya ke tabel horizontal.
         */
        async function loadAndRenderSchedule() {
            const container = document.getElementById('schedule-table-container');

            try {
                const scheduleRef = ref(db, 'recurring_templates');
                const snapshot = await get(scheduleRef);
                const weeklySchedule = snapshot.val() || {};

                // 1. Tentukan Hari yang Aktif (ada piket)
                const activeDays = getActiveDays(weeklySchedule);

                if (activeDays.length === 0) {
                     container.innerHTML = `
                        <div class="text-center py-20 text-gray-700 text-xl font-medium">
                            <h3 class="font-bold mb-2">Jadwal Kosong</h3>
                            </div>
                    `;
                    return;
                }

                renderHorizontalTable(weeklySchedule, container, activeDays);

            } catch (e) {
                console.error("Gagal memuat jadwal:", e);
                container.innerHTML = `
                    <div class="text-center py-20 text-red-500 text-xl font-medium">
                        Error: Gagal memuat data jadwal. Cek koneksi Firebase.
                    </div>
                `;
            }
        }

        /**
         * Menentukan hari-hari mana saja yang memiliki data piket.
         * @param {object} weeklySchedule - Data jadwal dari Firebase.
         * @returns {string[]} Array hari yang aktif, sesuai urutan.
         */
        function getActiveDays(weeklySchedule) {
            const activeDays = ALL_DAYS_OF_WEEK.filter(day => {
                const daySchedule = weeklySchedule[day];
                if (!daySchedule) return false;
                
                // Cek apakah ada pustakawan di shift pagi ATAU malam
                const hasPagi = (daySchedule.pagi || []).length > 0;
                const hasMalam = (daySchedule.malam || []).length > 0;
                
                return hasPagi || hasMalam;
            });
            return activeDays;
        }


        /**
         * Membuat HTML untuk satu baris shift (Pagi atau Malam).
         */
        function renderShiftRow(shiftInfo, weeklySchedule, activeDays) {
            const shiftKey = shiftInfo.key;
            let rowHtml = '<tr>';
            
            // First cell: Shift Name and Time (STIKY COLUMN)
            rowHtml += `
                <td>
                    <span class="shift-badge ${shiftInfo.badgeClass}">${shiftInfo.name}</span>
                    <div class="text-xs text-gray-500 mt-1">${shiftInfo.time}</div>
                </td>
            `;
            
            // Other cells: Librarians for each active day
            activeDays.forEach(day => {
                const daySchedule = weeklySchedule[day] || {};
                const librarians = daySchedule[shiftKey] || [];
                
                rowHtml += `<td>`;
                if (librarians.length > 0) {
                    // 1. Urutkan nama untuk tampilan yang rapi
                    librarians.sort((a,b) => a.name.localeCompare(b.name));
                    
                    // 2. Gabungkan semua nama menjadi satu string, dipisahkan koma
                    const librarianNames = librarians.map(lib => lib.name).join(', ');
                    
                    rowHtml += `<div class="librarian-text">${librarianNames}</div>`;
                } else {
                    rowHtml += `<span class="empty-cell">â€”</span>`; // Simbol dash untuk kosong
                }
                rowHtml += `</td>`;
            });
            
            rowHtml += '</tr>';
            return rowHtml;
        }

        /**
         * Membuat HTML untuk baris pembatas (Harian atau Pembina).
         */
        function createDividerRow(label, className, totalColumns) {
             // Menggunakan totalColumns yang dinamis
             return `
                <tr class="divider-row ${className}">
                    <td colspan="${totalColumns}">${label}</td>
                </tr>
            `;
        }


        /**
         * Membangun dan menampilkan tabel jadwal mingguan secara horizontal.
         */
        function renderHorizontalTable(weeklySchedule, container, activeDays) {
            
            const TOTAL_COLUMNS = activeDays.length + 1; // Shift + Active Days

            // 1. Setup Header (Active Days as columns)
            let headerHtml = '<th>Shift & Waktu</th>'; // First column for shift/time
            activeDays.forEach(day => {
                headerHtml += `<th class="text-center">${day}</th>`;
            });

            // 2. Setup Body 
            let bodyHtml = '';
            
            // --- BAGIAN PAGI ---
            const pagiShiftInfo = ALL_SHIFTS.find(s => s.key === 'pagi');
            if (pagiShiftInfo) {
                bodyHtml += renderShiftRow(pagiShiftInfo, weeklySchedule, activeDays);
            }

            // --- PEMBATAS 1: Harian & Pembina (SETELAH PAGI) ---
            bodyHtml += createDividerRow('Harian', 'divider-harian', TOTAL_COLUMNS);
            bodyHtml += createDividerRow('Pembina', 'divider-pembina', TOTAL_COLUMNS);


            // --- BAGIAN MALAM ---
            const malamShiftInfo = ALL_SHIFTS.find(s => s.key === 'malam');
             if (malamShiftInfo) {
                bodyHtml += renderShiftRow(malamShiftInfo, weeklySchedule, activeDays);
            }

            // --- PEMBATAS 2: Harian & Pembina (DI AKHIR) ---
            bodyHtml += createDividerRow('Harian', 'divider-harian', TOTAL_COLUMNS);
            bodyHtml += createDividerRow('Pembina', 'divider-pembina', TOTAL_COLUMNS);


            // 3. Assemble the full table HTML
            const fullTableHtml = `
                <table class="w-full divide-y divide-gray-200" style="border-collapse: collapse;">
                    <thead>
                        <tr>${headerHtml}</tr>
                    </thead>
                    <tbody class="bg-white" id="schedule-tbody">
                        ${bodyHtml}
                    </tbody>
                </table>
            `;

            container.innerHTML = fullTableHtml;
        }

        // --- INIT APP ---
        window.onload = () => {
             loadAndRenderSchedule();
        };
    </script>
</body>
</html>
