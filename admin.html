<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Pustakawan | Manajemen Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .container-card { max-width: 90%; margin: 0 auto; }
        /* Style kustom untuk badge status */
        .status-hadir { background-color: #10b981; color: white; }
        .status-izin { background-color: #fbbf24; color: #78350f; }
        .status-alpha { background-color: #ef4444; color: white; }
        .status-belum-absen { background-color: #9ca3af; color: white; }
        /* Style untuk tab aktif */
        .tab-active { background-color: #ffffff; color: #1f2937; border-bottom: 3px solid #3b82f6; }
        .tab-inactive { background-color: #f9fafb; color: #6b7280; border-bottom: 1px solid #e5e7eb; }
        /* Style untuk item drag and drop */
        .draggable-librarian { 
            cursor: grab; 
            border-left: 5px solid #3b82f6; 
        }
        .draggable-librarian:active {
            cursor: grabbing;
        }
        /* Style untuk dropzone */
        .dropzone {
            min-height: 100px;
            padding: 10px;
            border: 2px dashed #9ca3af;
            background-color: #f9fafb;
            transition: background-color 0.2s;
        }
        .dropzone.drag-over {
            background-color: #eef2ff; /* blue-50 */
            border-color: #3b82f6;
        }
    </style>
</head>
<body>

    <div id="app-container" class="min-h-screen p-4 sm:p-8">

        <header class="flex justify-between items-center mb-6 p-4 bg-white rounded-xl shadow-lg">
            <h1 class="text-2xl font-bold text-gray-800">Manajemen Sistem Absensi</h1>
            <nav>
                <a href="index.html" class="px-4 py-2 text-sm font-medium rounded-lg transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 shadow-md">
                    Absensi Pustakawan
                </a>
                <button class="ml-2 px-4 py-2 text-sm font-medium rounded-lg transition-colors bg-blue-600 text-white shadow-md">
                    Admin
                </button>
            </nav>
        </header>

        <main class="container-card">
            <div class="bg-white p-6 rounded-xl shadow-2xl">
                <div class="flex border-b mb-6">
                    <button id="tab-rekap" onclick="switchTab('rekap')" class="tab-active py-3 px-4 text-sm font-medium rounded-t-lg transition-colors">
                        Rekap Absensi
                    </button>
                    <button id="tab-librarian" onclick="switchTab('librarian')" class="tab-inactive py-3 px-4 text-sm font-medium rounded-t-lg transition-colors">
                        Manajemen Pustakawan
                    </button>
                    <button id="tab-schedule" onclick="switchTab('schedule')" class="tab-inactive py-3 px-4 text-sm font-medium rounded-t-lg transition-colors">
                        Atur Jadwal
                    </button>
                </div>

                <div id="tab-content">
                    </div>
            </div>
        </main>


        <div id="loading-indicator" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
            <div class="p-4 bg-white rounded-lg shadow-xl flex items-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-gray-700">Memuat data...</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, get, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // =================================================================
        // KONFIGURASI FIREBASE (HARUS SAMA DENGAN INDEX.HTML)
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBb-hbcc_ZE2hH6dlc81HbIGMQi96y4qYI",
            authDomain: "absensi-7ef83.firebaseapp.com",
            databaseURL: "https://absensi-7ef83-default-rtdb.firebaseio.com",
            projectId: "absensi-7ef83",
            storageBucket: "absensi-7ef83.firebasestorage.app",
            messagingSenderId: "661765044421",
            appId: "1:661765044421:web:b8578a195a6d208dc4d8ac"
        };
        // =================================================================

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let dbInstance = db;
        let currentTab = 'rekap';
        let allLibrarians = []; 
        let unsubscribeLibrarians = null; 
        
        // Konstanta Jadwal
        const SHIFT_PAGI = 'Pagi (08:00 - 11:00)';
        const SHIFT_MALAM = 'Malam (21:00 - 22:30)';
        const contentArea = document.getElementById('tab-content');
        
        // Array Hari dalam Seminggu
        const DAYS_OF_WEEK = ['Ahad', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];

        // State untuk Manajemen Jadwal Berulang
        let currentEditingDay = DAYS_OF_WEEK[0]; 
        let currentScheduleTemplate = {}; 


        // --- UTILITY FUNCTIONS ---
        function setLoading(show) {
            document.getElementById('loading-indicator').classList.toggle('hidden', !show);
        }

        function formatDateToKey(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        /**
         * Mengembalikan tanggal hari Ahad (Sunday) sebagai kunci minggu (YYYY-MM-DD)
         * dari tanggal yang diberikan.
         */
        function getSundayOfWeek(dateKey) {
            const [year, month, day] = dateKey.split('-').map(Number);
            // month - 1 karena Date constructor menggunakan bulan 0-indexed
            const date = new Date(year, month - 1, day); 
            
            // Get the day of the week (0 = Sunday)
            const dayOfWeek = date.getDay(); 
            
            // Adjust to the previous Sunday
            date.setDate(date.getDate() - dayOfWeek); 
            
            // Format back to YYYY-MM-DD
            return formatDateToKey(date); 
        }

        /**
         * Mengembalikan rentang tanggal Ahad sampai Sabtu dalam format bahasa Indonesia.
         */
        function formatWeekRange(sundayDateKey) {
            const [year, month, day] = sundayDateKey.split('-').map(Number);
            const sundayDate = new Date(year, month - 1, day); 
            const saturdayDate = new Date(sundayDate);
            saturdayDate.setDate(sundayDate.getDate() + 6);

            const dateOptions = { day: 'numeric', month: 'long', year: 'numeric' };

            const sundayFormatted = sundayDate.toLocaleDateString('id-ID', dateOptions);
            const saturdayFormatted = saturdayDate.toLocaleDateString('id-ID', dateOptions);
            
            return `Ahad ${sundayFormatted} - Sabtu ${saturdayFormatted}`;
        }
        
        function renderMessage(type, message) {
            let color = '';
            if (type === 'success') color = 'bg-green-100 text-green-700 border-green-500';
            else if (type === 'error') color = 'bg-red-100 text-red-700 border-red-500';
            else color = 'bg-blue-100 text-blue-700 border-blue-500';
            
            return `<div class="p-3 mb-4 border-l-4 rounded-lg ${color}">${message}</div>`;
        }
        
        // --- CRUD Pustakawan (Librarian Management Logic - NO CHANGE) ---

        // Fungsi untuk menambahkan/mengubah pustakawan (GLOBAL)
        window.saveLibrarian = async (event) => {
            event.preventDefault();
            setLoading(true);
            contentArea.querySelectorAll('.p-3.mb-4').forEach(el => el.remove()); 
            
            const name = document.getElementById('librarian-name').value.trim();
            const id = document.getElementById('librarian-id').value.trim();
            const existingKey = document.getElementById('librarian-key').value;
            const keyPath = existingKey ? `librarians/${existingKey}` : 'librarians';

            if (!name || !id) {
                contentArea.insertAdjacentHTML('afterbegin', renderMessage('error', 'Nama dan ID Pustakawan harus diisi.'));
                setLoading(false);
                return;
            }
            
            if (!existingKey && allLibrarians.some(lib => lib.id === id)) {
                contentArea.insertAdjacentHTML('afterbegin', renderMessage('error', `ID ${id} sudah digunakan oleh pustakawan lain. Harap gunakan ID unik.`));
                setLoading(false);
                return;
            }

            try {
                const data = { name: name, id: id };
                if (existingKey) {
                    await update(ref(dbInstance, keyPath), data);
                    contentArea.insertAdjacentHTML('afterbegin', renderMessage('success', 'Pustakawan berhasil diperbarui!'));
                } else {
                    const newRef = push(ref(dbInstance, keyPath));
                    await set(newRef, data);
                    contentArea.insertAdjacentHTML('afterbegin', renderMessage('success', 'Pustakawan baru berhasil ditambahkan!'));
                }
                document.getElementById('librarian-form').reset();
                document.getElementById('librarian-key').value = '';
                document.getElementById('form-title').textContent = 'Tambah Pustakawan Baru';
            } catch (e) {
                console.error("Gagal menyimpan pustakawan:", e);
                contentArea.insertAdjacentHTML('afterbegin', renderMessage('error', `Gagal menyimpan data: ${e.message}`));
            } finally {
                setLoading(false);
            }
        };

        // Fungsi untuk mengisi form edit (GLOBAL)
        window.editLibrarian = (key, name, id) => {
            document.getElementById('librarian-key').value = key;
            document.getElementById('librarian-name').value = name;
            document.getElementById('librarian-id').value = id;
            document.getElementById('form-title').textContent = 'Edit Pustakawan';
        };

        // Fungsi untuk menghapus pustakawan (GLOBAL)
        window.deleteLibrarian = async (key, name) => {
            if (!confirm(`Yakin ingin menghapus pustakawan ${name}? Aksi ini tidak dapat dibatalkan dan akan menghapus semua referensi dari template jadwal berulang.`)) return; 

            setLoading(true);
            try {
                // 1. Hapus entri pustakawan
                await remove(ref(dbInstance, `librarians/${key}`));

                // 2. Hapus referensi dari template jadwal berulang
                const templatesRef = ref(dbInstance, 'recurring_templates');
                const templateSnapshot = await get(templatesRef);

                if (templateSnapshot.exists()) {
                    const updates = {};
                    const templates = templateSnapshot.val();
                    // Cari ID pustakawan dari key sebelum dihapus
                    const librarianIdToDelete = allLibrarians.find(lib => lib.key === key)?.id; 

                    for (const day in templates) {
                        const template = templates[day];
                        let updated = false;

                        // Filter Shift Pagi
                        const newPagi = (template.pagi || []).filter(lib => lib.librarianId !== librarianIdToDelete);
                        if (newPagi.length !== (template.pagi || []).length) {
                            updates[`recurring_templates/${day}/pagi`] = newPagi;
                            updated = true;
                        }

                        // Filter Shift Malam
                        const newMalam = (template.malam || []).filter(lib => lib.librarianId !== librarianIdToDelete);
                        if (newMalam.length !== (template.malam || []).length) {
                            updates[`recurring_templates/${day}/malam`] = newMalam;
                            updated = true;
                        }
                    }

                    if (Object.keys(updates).length > 0) {
                        await update(ref(dbInstance, '/'), updates);
                        console.log("Referensi pustakawan dihapus dari template jadwal berulang.");
                    }
                }
                
                contentArea.insertAdjacentHTML('afterbegin', renderMessage('success', `${name} berhasil dihapus. Template jadwal telah diperbarui.`));

            } catch (e) {
                console.error("Gagal menghapus pustakawan:", e);
                contentArea.insertAdjacentHTML('afterbegin', renderMessage('error', `Gagal menghapus: ${e.message}`));
            } finally {
                setLoading(false);
            }
        };

        // Render Librarian Management Tab
        function renderLibrarianManagement() {
            contentArea.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 p-5 border border-blue-200 rounded-xl bg-blue-50 h-fit">
                        <h3 id="form-title" class="text-xl font-bold text-blue-700 mb-4">Tambah Pustakawan Baru</h3>
                        <form id="librarian-form" onsubmit="saveLibrarian(event)">
                            <input type="hidden" id="librarian-key">
                            <div class="mb-4">
                                <label for="librarian-name" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                                <input type="text" id="librarian-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div class="mb-4">
                                <label for="librarian-id" class="block text-sm font-medium text-gray-700">ID Pustakawan (Contoh: LIB001)</label>
                                <input type="text" id="librarian-id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-150">
                                Simpan Pustakawan
                            </button>
                        </form>
                    </div>

                    <div class="lg:col-span-2 p-5 bg-white rounded-xl shadow-md border">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Daftar Pustakawan Aktif (${allLibrarians.length})</h3>
                        <div id="librarian-list" class="space-y-3">
                            ${allLibrarians.length === 0 ? '<p class="text-gray-500 italic">Belum ada pustakawan yang terdaftar.</p>' : allLibrarians.map(lib => `
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg shadow-sm border">
                                    <div class="flex-grow">
                                        <p class="font-semibold">${lib.name}</p>
                                        <p class="text-xs text-gray-500">ID: ${lib.id}</p>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button onclick="editLibrarian('${lib.key}', '${lib.name}', '${lib.id}')" class="p-2 text-blue-500 hover:text-blue-700 transition" title="Edit">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-1.414 7.07l-4 4V17h3l4-4-3-3zm-6.172-1.879l5.05-5.05 2.828 2.828-5.05 5.05-2.828-2.828zM17 18H3V6a2 2 0 012-2h4a1 1 0 000-2H5a4 4 0 00-4 4v12a4 4 0 004 4h12a4 4 0 004-4v-4a1 1 0 00-2 0v4a2 2 0 01-2 2z"/></svg>
                                        </button>
                                        <button onclick="deleteLibrarian('${lib.key}', '${lib.name}')" class="p-2 text-red-500 hover:text-red-700 transition" title="Hapus">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /><path d="M10 2a1 1 0 00-1 1v1h2V3a1 1 0 00-1-1zM5 6a1 1 0 000 2h10a1 1 0 100-2H5zM4 10a1 1 0 000 2h12a1 1 0 100-2H4z"/></svg>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- Drag and Drop Handlers (GLOBAL - NO CHANGE) ---
        window.dragStart = (event) => {
            event.dataTransfer.setData('text/plain', event.target.dataset.librarianId);
            event.dataTransfer.effectAllowed = 'move';
            // Optional: Add visual feedback for the dragged item
            event.target.classList.add('opacity-50'); 
        };

        window.dragEnd = (event) => {
            // Remove visual feedback
            event.target.classList.remove('opacity-50');
        };

        window.dragOver = (event) => {
            event.preventDefault(); // Mencegah default untuk mengizinkan drop
            event.dataTransfer.dropEffect = 'move';
            // Optional: Visual feedback on hover
            if (event.target.closest('.dropzone')) {
                 event.target.closest('.dropzone').classList.add('drag-over');
            }
        };

        window.dragLeave = (event) => {
             if (event.target.classList.contains('dropzone')) {
                event.target.classList.remove('drag-over');
             }
        };


        /**
         * Fungsi global untuk menetapkan pustakawan ke shift via DROP.
         */
        window.handleDrop = (event, targetShift) => {
            event.preventDefault();
            // Remove drag-over styling
            event.target.closest('.dropzone').classList.remove('drag-over'); 

            const librarianId = event.dataTransfer.getData('text/plain');
            
            // Panggil fungsi untuk menetapkan (ADD)
            assignLibrarian(librarianId, targetShift);
        };
        
        /**
         * Fungsi untuk menghapus pustakawan dari shift (dipicu oleh klik X di item jadwal).
         */
        window.removeAssignment = (librarianId, shift) => {
            // Panggil fungsi untuk menghapus (REMOVE)
            removeLibrarian(librarianId, shift);
        }
        
        /**
         * Core Logic: Menetapkan pustakawan ke shift (ADD ONLY jika belum ada di shift tersebut).
         * Mengizinkan pustakawan berada di shift Pagi dan Malam.
         */
        function assignLibrarian(librarianId, shift) {
            let currentShiftList = currentScheduleTemplate[shift] || [];
            
            const librarian = allLibrarians.find(l => l.id === librarianId);
            if (!librarian) return;

            // Cari apakah pustakawan sudah ada di shift target
            const indexInCurrent = currentShiftList.findIndex(l => l.librarianId === librarianId);
            
            // HANYA TAMBAHKAN jika belum ada di shift ini (mencegah duplikasi dalam satu shift)
            if (indexInCurrent === -1) { 
                if (!currentScheduleTemplate[shift]) currentScheduleTemplate[shift] = []; 
                
                // Add the new assignment object
                currentScheduleTemplate[shift].push({ 
                    librarianId: librarian.id, 
                    name: librarian.name, 
                    status: 'Belum Absen', 
                    checkIn: null,        
                    absentBy: null        
                });
                
                // Clean up and re-sort
                currentScheduleTemplate[shift].sort((a,b) => a.name.localeCompare(b.name));
                
                updateAssignmentPanelUI(); // Update UI
                
                // Add message to remind user to save
                const saveReminderMsg = document.getElementById('save-reminder-msg');
                if (!saveReminderMsg) {
                    const panel = document.getElementById('schedule-assignment-panel');
                    panel.insertAdjacentHTML('afterbegin', '<div id="save-reminder-msg" class="p-3 mb-4 border-l-4 border-yellow-500 bg-yellow-100 text-yellow-800 rounded-lg">Template jadwal telah diubah. Jangan lupa klik tombol "Simpan Template Jadwal" di bawah.</div>');
                }
            }
        }

        /**
         * Core Logic: Menghapus pustakawan dari shift (REMOVE ONLY).
         */
        function removeLibrarian(librarianId, shift) {
            let currentShiftList = currentScheduleTemplate[shift] || [];
            
            // Hapus dari shift saat ini
            currentScheduleTemplate[shift] = currentShiftList.filter(l => l.librarianId !== librarianId);
            
            // Clean up and re-sort
            currentScheduleTemplate[shift].sort((a,b) => a.name.localeCompare(b.name));

            updateAssignmentPanelUI();
            
            // Add message to remind user to save
            const saveReminderMsg = document.getElementById('save-reminder-msg');
            if (!saveReminderMsg) {
                const panel = document.getElementById('schedule-assignment-panel');
                panel.insertAdjacentHTML('afterbegin', '<div id="save-reminder-msg" class="p-3 mb-4 border-l-4 border-yellow-500 bg-yellow-100 text-yellow-800 rounded-lg">Template jadwal telah diubah. Jangan lupa klik tombol "Simpan Template Jadwal" di bawah.</div>');
            }
        }


        // --- Recurring Schedule Management Logic (NO CHANGE) ---

        /**
         * Mengubah tampilan dan memuat template jadwal untuk hari yang dipilih.
         */
        window.switchDayTab = (dayName) => {
            currentEditingDay = dayName;
            
            // 1. Update Tab Styles (Div Per Hari)
            document.querySelectorAll('#day-tabs button').forEach(btn => {
                if (btn.getAttribute('data-day') === dayName) {
                    btn.classList.replace('bg-white', 'bg-purple-600');
                    btn.classList.replace('text-purple-600', 'text-white');
                    btn.classList.add('shadow-md');
                } else {
                    btn.classList.replace('bg-purple-600', 'bg-white');
                    btn.classList.replace('text-white', 'text-purple-600');
                    btn.classList.remove('shadow-md');
                    btn.classList.add('hover:bg-purple-100');
                }
            });

            // 2. Update Display Text
            const currentDayDisplay = document.getElementById('current-day-display');
            const saveDayDisplay = document.getElementById('schedule-save-day-display');
            if(currentDayDisplay) currentDayDisplay.textContent = dayName;
            if(saveDayDisplay) saveDayDisplay.textContent = dayName;

            // 3. Load the schedule template for the new day
            loadScheduleTemplateForDay(dayName);
        }

        /**
         * Memuat template jadwal harian dari Firebase.
         */
        async function loadScheduleTemplateForDay(dayName) {
            setLoading(true);
            // Hapus pesan peringatan simpan saat hari berganti
            const saveReminderMsg = document.getElementById('save-reminder-msg');
            if (saveReminderMsg) saveReminderMsg.remove(); 
            
            const schedulePath = `recurring_templates/${dayName}`;

            try {
                const snapshot = await get(ref(dbInstance, schedulePath));
                currentScheduleTemplate = snapshot.val() || { day: dayName, pagi: [], malam: [] };
                
                // Update the UI based on the loaded template
                updateAssignmentPanelUI();

            } catch(e) {
                console.error("Gagal memuat template jadwal:", e);
                currentScheduleTemplate = { day: dayName, pagi: [], malam: [] };
                updateAssignmentPanelUI(); // Fallback to empty UI
            } finally {
                setLoading(false);
            }
        }

        /**
         * Memperbarui UI kedua panel (Jadwal dan Daftar Pustakawan).
         * Semua pustakawan kini ditampilkan di panel kanan.
         */
        function updateAssignmentPanelUI() {
            // Semua pustakawan harus selalu tersedia di panel kanan meskipun sudah terjadwal di shift lain/sama.
            const allLibrariansSource = allLibrarians; 
            
            // Ids yang sudah ditetapkan di hari ini (untuk indikator visual)
            const assignedIds = new Set([
                ...(currentScheduleTemplate.pagi || []).map(l => l.librarianId),
                ...(currentScheduleTemplate.malam || []).map(l => l.librarianId)
            ]);
            
            // 1. Update Librarian List (Source Panel)
            const librarianSourcePanel = document.getElementById('librarian-source-list');
            
            if (librarianSourcePanel) {
                librarianSourcePanel.innerHTML = allLibrariansSource.length === 0 
                    ? '<p class="text-gray-500 italic p-3">Belum ada pustakawan yang terdaftar.</p>'
                    : allLibrariansSource.map(lib => {
                        // Check if assigned to any shift for visual indicator
                        const isAssigned = assignedIds.has(lib.id);
                        
                        return `
                        <div id="lib-source-${lib.id}" data-librarian-id="${lib.id}" draggable="true" 
                             ondragstart="dragStart(event)" ondragend="dragEnd(event)"
                             class="draggable-librarian p-3 bg-white border rounded-lg shadow-sm hover:bg-gray-50 transition duration-150 mb-2 
                             ${isAssigned ? 'border-purple-500' : 'border-gray-200'}">
                            <span class="font-medium text-gray-800">${lib.name}</span>
                            <span class="text-xs text-gray-500 ml-2">${lib.id} ${isAssigned ? ' (Terjadwal)' : ''}</span>
                        </div>
                    `;
                }).join('');
            }
            
            // 2. Update Schedule Dropzones (Target Panel)
            
            // Render Pagi Shift
            const pagiDropzone = document.getElementById('pagi-dropzone');
            if (pagiDropzone) {
                const pagiLibrarians = currentScheduleTemplate.pagi || [];
                pagiDropzone.innerHTML = pagiLibrarians.length === 0 
                    ? '<p class="text-gray-400 italic text-center py-4">Seret & Lepaskan Pustakawan untuk Shift Pagi di sini.</p>'
                    : pagiLibrarians.map(lib => `
                        <div class="flex items-center justify-between p-2 bg-purple-100 border border-purple-300 rounded-md mb-2">
                            <span>${lib.name} (${lib.librarianId})</span>
                            <button onclick="removeAssignment('${lib.librarianId}', 'pagi')" class="text-red-500 hover:text-red-700 transition" title="Hapus dari shift">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                    `).join('');
            }

            // Render Malam Shift
            const malamDropzone = document.getElementById('malam-dropzone');
            if (malamDropzone) {
                const malamLibrarians = currentScheduleTemplate.malam || [];
                malamDropzone.innerHTML = malamLibrarians.length === 0 
                    ? '<p class="text-gray-400 italic text-center py-4">Seret & Lepaskan Pustakawan untuk Shift Malam di sini.</p>'
                    : malamLibrarians.map(lib => `
                        <div class="flex items-center justify-between p-2 bg-purple-100 border border-purple-300 rounded-md mb-2">
                            <span>${lib.name} (${lib.librarianId})</span>
                            <button onclick="removeAssignment('${lib.librarianId}', 'malam')" class="text-red-500 hover:text-red-700 transition" title="Hapus dari shift">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                    `).join('');
            }
        }
        

        /**
         * Menyimpan template jadwal berulang ke Firebase.
         */
        window.saveRecurringSchedule = async () => {
            setLoading(true);
            contentArea.querySelectorAll('.p-3.mb-4').forEach(el => el.remove()); 
            
            const selectedDay = currentEditingDay;
            const saveReminderMsg = document.getElementById('save-reminder-msg');
            if (saveReminderMsg) saveReminderMsg.remove(); 

            const schedulePath = `recurring_templates/${selectedDay}`;
            
            try {
                // Template sudah disiapkan di currentScheduleTemplate
                await set(ref(dbInstance, schedulePath), currentScheduleTemplate);
                contentArea.insertAdjacentHTML('afterbegin', renderMessage('success', `Template Jadwal Hari ${selectedDay} berhasil diperbarui!`));
            } catch (e) {
                console.error("Gagal menyimpan template jadwal:", e);
                contentArea.insertAdjacentHTML('afterbegin', renderMessage('error', `Gagal menyimpan template: ${e.message}`));
            } finally {
                setLoading(false);
            }
        };


        function renderScheduleManagement() {
            contentArea.innerHTML = `
                <div class="p-5 border border-purple-200 rounded-xl bg-purple-50">
                    <h3 class="text-xl font-bold text-purple-700 mb-4">Atur Template Jadwal</h3>
                    
                    <p class="text-sm text-gray-600 mb-4">Pilih Hari, lalu **Seret & Lepaskan** nama pustakawan dari panel kanan ke kotak shift **Pagi** atau **Malam** di panel jadwal. Satu pustakawan dapat memiliki dua shift (Pagi dan Malam) pada hari yang sama.</p>
                    
                    <div id="day-tabs" class="flex flex-wrap gap-2 mb-6 border-b border-purple-200 pb-3">
                        ${DAYS_OF_WEEK.map((day, index) => `
                            <button onclick="switchDayTab('${day}')" data-day="${day}" 
                                class="py-2 px-4 text-sm font-medium rounded-lg transition-colors border border-purple-300 
                                ${index === 0 ? 'bg-purple-600 text-white shadow-md' : 'bg-white text-purple-600 hover:bg-purple-100'}">
                                ${day}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md border" id="schedule-assignment-panel">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Jadwal Hari <span id="current-day-display" class="text-purple-600">${DAYS_OF_WEEK[0]}</span></h4>
                            
                            ${allLibrarians.length === 0 ? 
                                '<p class="text-gray-500 italic">Tambahkan pustakawan di tab "Manajemen Pustakawan" terlebih dahulu.</p>' :
                                `
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    <div class="p-4 border border-green-300 bg-green-50 rounded-lg">
                                        <p class="font-bold text-green-700 mb-2">Shift Pagi</p>
                                        <p class="text-xs text-green-600 mb-2">${SHIFT_PAGI}</p>
                                        <div id="pagi-dropzone" 
                                             class="dropzone space-y-2 rounded-md transition-colors"
                                             ondragover="dragOver(event)"
                                             ondragleave="dragLeave(event)"
                                             ondrop="handleDrop(event, 'pagi')">
                                            </div>
                                    </div>
                                    
                                    <div class="p-4 border border-yellow-300 bg-yellow-50 rounded-lg">
                                        <p class="font-bold text-yellow-700 mb-2">Shift Malam</p>
                                        <p class="text-xs text-yellow-600 mb-2">${SHIFT_MALAM}</p>
                                        <div id="malam-dropzone" 
                                             class="dropzone space-y-2 rounded-md transition-colors"
                                             ondragover="dragOver(event)"
                                             ondragleave="dragLeave(event)"
                                             ondrop="handleDrop(event, 'malam')">
                                            </div>
                                    </div>
                                </div>
    
                                <div class="mt-4">
                                    <button onclick="saveRecurringSchedule()" 
                                        class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 transition duration-150">
                                        Simpan Template Jadwal Hari <span id="schedule-save-day-display">${DAYS_OF_WEEK[0]}</span>
                                    </button>
                                </div>
                            `}
                        </div>

                        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md border h-fit">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Daftar Pustakawan</h4>
                            <div id="librarian-source-list" class="flex flex-col space-y-3 max-h-96 overflow-y-auto pr-2">
                                </div>
                        </div>
                    </div>

                </div>
            `;
            
            // Panggil switchDayTab untuk memuat jadwal hari pertama saat tab dibuka
            switchDayTab(currentEditingDay); 
        }

        // --- Rekap Absensi Logic (MODIFIED) ---

        /**
         * Mengubah data ringkasan mingguan menjadi format teks laporan.
         */
        function generateReportText(weekRange, summary) {
            let report = `REKAP ABSENSI PUSTAKAWAN MINGGUAN\n`;
            report += `Periode: ${weekRange}\n`;
            report += `========================================\n`;
            report += `\n`;
            report += `Nama Pustakawan\tHadir\tIzin\tAlpha\n`;
            
            summary.forEach(lib => {
                report += `${lib.name}\t${lib.Hadir}\t${lib.Izin}\t${lib.Alpha}\n`;
            });
            
            report += `\n(Laporan ini dibuat otomatis)`;

            return report;
        }

        /**
         * Fungsi global untuk menyalin laporan mingguan ke clipboard.
         */
        window.copyWeeklyReport = async (reportTextEncoded) => {
            const reportText = decodeURIComponent(reportTextEncoded);
            try {
                // Check if clipboard API is available
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(reportText);
                    alert('Laporan berhasil disalin ke clipboard!');
                } else {
                    // Fallback for older browsers (less reliable)
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = reportText;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextArea);
                    alert('Laporan berhasil disalin ke clipboard (Metode Fallback)!');
                }
            } catch (err) {
                console.error('Gagal menyalin laporan:', err);
                alert('Gagal menyalin laporan. Pastikan Anda menggunakan browser modern dan izin clipboard diberikan.');
            }
        };
        
        /**
         * Mengelompokkan semua catatan absensi harian ke dalam ringkasan per minggu.
         */
        function groupRecordsByWeek(records) {
            const weeklyData = {}; // Key: Sunday Date (YYYY-MM-DD), Value: { summary: { librarianId: { name, Hadir, Izin, Alpha } } }

            records.forEach(record => {
                const dateKey = record.dayKey; 
                if (!dateKey) return; 

                // 1. Tentukan kunci minggu (tanggal hari Ahad)
                const weekKey = getSundayOfWeek(dateKey); 

                // 2. Inisialisasi data minggu tersebut jika belum ada
                if (!weeklyData[weekKey]) {
                    weeklyData[weekKey] = {
                        summary: {} // Ringkasan untuk minggu ini
                    };
                }

                // 3. Agregasi absensi untuk minggu tersebut
                const allLibrariansInRecord = [...(record.pagi || []), ...(record.malam || [])];
                
                allLibrariansInRecord.forEach(lib => {
                    const id = lib.librarianId;
                    const status = lib.status; // Bisa 'Hadir', 'Izin', 'Alpha', 'Belum Absen'

                    // Hanya agregasi status yang relevan (Hadir, Izin, Alpha)
                    if (status !== 'Belum Absen') {
                        if (!weeklyData[weekKey].summary[id]) {
                            const globalLib = allLibrarians.find(l => l.id === id);
                            weeklyData[weekKey].summary[id] = { 
                                name: globalLib ? globalLib.name : lib.name, 
                                Hadir: 0, 
                                Izin: 0, 
                                Alpha: 0 
                            };
                        }

                        if (weeklyData[weekKey].summary[id].hasOwnProperty(status)) {
                            weeklyData[weekKey].summary[id][status]++;
                        }
                    }
                });
            });
            
            // Konversi ringkasan objek menjadi array yang diurutkan untuk rendering akhir
            const sortedWeeksKeys = Object.keys(weeklyData).sort().reverse(); // Urutkan minggu terbaru di atas

            const finalData = sortedWeeksKeys.map(weekKey => ({
                weekStart: weekKey,
                weekRange: formatWeekRange(weekKey), // Rentang Ahad - Sabtu
                summary: Object.values(weeklyData[weekKey].summary).sort((a, b) => a.name.localeCompare(b.name))
            }));
            
            return finalData;
        }


        /**
         * Merender tampilan rekap absensi per minggu.
         */
        function renderWeeklyRecap(weeklyData) {
            const contentArea = document.getElementById('tab-content');
            
            contentArea.innerHTML = `
                <h2 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2">Rekap Absensi Mingguan</h2>
                
                ${weeklyData.length === 0 ? `
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-lg">Belum ada data absensi yang tercatat untuk dikelompokkan per minggu.</p>
                        <p class="text-sm">Silakan cek absensi harian dan pastikan pustakawan sudah ditetapkan jadwalnya.</p>
                    </div>
                ` : weeklyData.map(week => {
                    
                    // 1. Generate the report text for copying and encode it
                    const reportText = generateReportText(week.weekRange, week.summary);
                    const encodedReportText = encodeURIComponent(reportText);

                    // 2. Return the HTML for the weekly box
                    return `
                    <div class="mb-8 p-6 bg-white rounded-xl shadow-2xl border border-gray-100">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 border-b pb-2">
                            <h3 class="text-xl font-bold text-gray-700 mb-2 sm:mb-0">Rekap Absensi Minggu: ${week.weekRange}</h3>
                            <button onclick="copyWeeklyReport('${encodedReportText}')"
                                class="flex items-center justify-center sm:justify-start space-x-1 px-3 py-1 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v2a2 2 0 01-2 2h-1M12 7v10m-3-3h6" />
                                </svg>
                                <span>Salin Laporan</span>
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Pustakawan</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Hadir</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Izin</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Alpha</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${week.summary.map(lib => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${lib.name}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-bold ${lib.Hadir > 0 ? 'text-green-600' : 'text-gray-400'}">${lib.Hadir}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-bold ${lib.Izin > 0 ? 'text-yellow-600' : 'text-gray-400'}">${lib.Izin}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-bold ${lib.Alpha > 0 ? 'text-red-600' : 'text-gray-400'}">${lib.Alpha}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    `;
                }).join('')}
            `;
        }

        async function loadRekapView() {
            setLoading(true);
            contentArea.innerHTML = ''; 

            try {
                const schedulesRef = ref(dbInstance, 'librarian_schedules');
                const snapshot = await get(schedulesRef);

                const records = [];
                if (snapshot.exists()) {
                    const schedulesObject = snapshot.val();
                    for (const dateKey in schedulesObject) { 
                        // Inject the dateKey (YYYY-MM-DD) into the record for weekly grouping
                        records.push({ dayKey: dateKey, ...schedulesObject[dateKey] }); 
                    }
                }
                
                // Group and calculate summary by week
                const weeklySummary = groupRecordsByWeek(records);
                renderWeeklyRecap(weeklySummary);

            } catch (e) {
                console.error("Gagal memuat catatan rekapitulasi:", e);
                contentArea.innerHTML = renderMessage('error', `Error: Gagal memuat data rekapitulasi. ${e.message}`);
            } finally {
                setLoading(false);
            }
        }

        // --- Tab Control and Data Loaders (NO CHANGE) ---
        
        window.switchTab = (newTab) => {
            currentTab = newTab;
            contentArea.querySelectorAll('.p-3.mb-4').forEach(el => el.remove()); 
            
            ['rekap', 'librarian', 'schedule'].forEach(tab => {
                const btn = document.getElementById(`tab-${tab}`);
                if (btn) {
                    if (tab === newTab) {
                        btn.classList.replace('tab-inactive', 'tab-active');
                    } else {
                        btn.classList.replace('tab-active', 'tab-inactive');
                    }
                }
            });

            if (newTab === 'rekap') {
                loadRekapView();
            } else if (newTab === 'librarian') {
                renderLibrarianManagement(); 
            } else if (newTab === 'schedule') {
                renderScheduleManagement();
            }
        }
        
        function setupLibrarianListener() {
            if (unsubscribeLibrarians) return; 

            unsubscribeLibrarians = onValue(ref(dbInstance, 'librarians'), (snapshot) => {
                const libsObj = snapshot.val();
                allLibrarians = [];
                if (libsObj) {
                    for (const key in libsObj) {
                        allLibrarians.push({ key: key, ...libsObj[key] });
                    }
                }
                // Jika sedang di tab yang membutuhkan daftar pustakawan, muat ulang
                if (currentTab === 'librarian') {
                    renderLibrarianManagement();
                } else if (currentTab === 'schedule') {
                    // Panggil updateAssignmentPanelUI untuk memperbarui daftar pustakawan di panel kanan.
                    updateAssignmentPanelUI(); 
                }
            }, (error) => {
                console.error("Error fetching librarians:", error);
            });
        }
        
        // --- INIT APP ---
        window.onload = () => {
             setupLibrarianListener(); 
             switchTab('rekap');
        };
    </script>
</body>
</html>
